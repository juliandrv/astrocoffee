---
import PostMeta from "@/components/blog/PostMeta.astro";
import Layout from "@/layouts/Layout.astro";
import { PostWPSchema, PostsWPListSchema, type Post } from "@/types";

export const prerender = true;

// 1️⃣ Genera todas las rutas en build
export async function getStaticPaths() {
  const API = import.meta.env.API_WP_URL!;

  if (!API) {
    throw new Error("API_WP_URL no está definida en el entorno");
  }

  const res = await fetch(`${API}/posts`);
  const json = await res.json();
  const posts: Post[] = PostsWPListSchema.parse(json);

  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

// 2️⃣ Obtiene datos del post en build time
const API = import.meta.env.API_WP_URL!;
const { slug } = Astro.params;

const response = await fetch(`${API}/posts?slug=${slug}`);
const json = await response.json();
const data = PostWPSchema.safeParse(json[0]);

if (!data.success) {
  throw new Error("Post inválido en build");
}

const { title, content, featured_image_url, date, category_list } = data.data;
---

<Layout
  title={title.rendered}
  subtitle={title.rendered}
  bgImage={featured_image_url}
>
  <article class="space-y-3 max-w-2xl mx-auto">
    <PostMeta date={date} category_list={category_list} />
    <div set:html={content.rendered} class="space-y-3 mt-6" />
  </article>
</Layout>
